---
title: "Untitled"
author: "annika"
date: "`r Sys.Date()`"
output: 
  flexdashboard::flex_dashboard:
    orientation: rows
    fig_retina: 3
    dev: "svg"
    fig_width: 7.3
    fig_height: 4.5
params:
  placeExamining: "sf"
  yearExamining: "2018"
  yvarLIST: "logsum_trip_mode_AS_trips"
  yvarTITLE: "Potential INEXUS"
  yvarMINmax: "scale_x_continuous(limits = c(0,2))"
editor_options: 
  chunk_output_type: inline
  markdown:
    wrap: 41
---

```{r setup, include=FALSE}
# thematic: thematic_rmd()
knitr::opts_chunk$set(echo = FALSE,
                      dev = "svg",
                      out.width = 7.3*82
                      )
```

# library

```{r library, include=FALSE}
# library(tikzDevice) # to get really really good looking things use dev tikz
library(kableExtra)
library(Cairo)
library(tinytex)
# cairo_null_device(4, 3.2)
library(flextable)
library(ggplot2)
# library(magick)
library(readr)
# library(purrr)
library(khroma) 
library(patchwork)
library(flexdashboard)
library(ggridges)
library(ggExtra) # marginal plots
library(ggrepel) # make labels not overlap
# library(cowplot) 
library(stringr)
library(scales)
# library(plotly) # make interactive!
# library(Hmisc)
library(stargazer)
library(svglite)
library(dplyr)
library(tidyverse)
# library(gghighlight)    # highlight one part of plot
# library(usethis)

```

<!-- Y var {.sidebar data-width=50} -->

<!-- --------------------------------------------------------------------- -->

```{r clear}
# rm(list = ls())
gc()
```

# Save Graphs?

```{r}
saveGraphsTF = TRUE
```

# DEFINE Y

### Y Variables

```{r}
listY <- list("logsum_trip_mode_AS_trips","duration_door_to_door")

```

### define Het

```{r g_Het_WithinScenario, echo=FALSE}
# With imap, going through a list using a |> , .x is the thing in the list, and .y is the name of the thing in the list.  So like, .x is each dataframe in the list, and .y is the name of the dataframe in the list. The other way is    map2( .x = df_in_a_list, .y = names(df_in_a_list), ~fx_H...
listHet       <- list("ownCarYNLabel", "l_inc_HiLo10")
# listHetFilter <- list(df_in_a_list, data_inc_HiLo10)
print(listHet)
```

# Graphics test {data-icon="fa-signal"}

## 

### TEST of graphics

Make sure width and size are consistent
with what i see

```{r TEST, eval=FALSE, include=FALSE}
df <- tibble::tribble( ~x, ~y, ~name,
  1,  1,  "12pt font",
  3,  3,  "f",
  2,  2,  "This text is two inches")
OneInchInmm <- 25.4
mmOf12ptFont <- 12 / .pt
device.size.px <- dev.size(units="px")
device.size.in <- dev.size(units="in")
device.size.px.per.in <- dev.size("px")/dev.size("in")


# Test graph
ggplot(df, aes(x = x, y = y, label = name)) +
  geom_text(size = mmOf12ptFont) +
  geom_point(size = mmOf12ptFont, shape = 7) +
  geom_point(size = 2*OneInchInmm, shape = 7) +
  theme( plot.title = element_text(size = 12)) +
  # The graph title has info about the size of the graphics in it
  labs(title = paste(
  "This text is two inches 
[IT IS 12 POINT FONT][which is 12char per inch]
---size of text and points within the graph is in mm, .pt is a var in ggplot
---where the mm are font size / .pt, so for font size 12, mm are", 12/.pt,"mm.
---the boxes are two inches, which is 2 times 12 /.pt,",12/.pt,"mm.
[This PLOT SIZE IS probably 7.3 WIDTH, 4.5 HEIGHT:
---- ",dev.size("in")[1],"by", dev.size("in")[2],"same as",device.size.in[1],device.size.in[2],"
[device size pixels rstudio, and for rendered:",dev.size("px")[1],"by",dev.size("px")[2],device.size.px[1],device.size.px[2],"
[furthermore if you set the break at 48 columns'][then this is 4in and, total is 8 inches across]
---Pix per inch:", dev.size("px")/dev.size("in"),"or", device.size.px.per.in,". range:", par("usr"),   par("usr")[c(2,4)] - par("usr")[c(1,3)],
"---Pct devoted to plot:", par("plt")[c(2,4)] - par("plt")[c(1,3)][1],par("plt")[c(2,4)] - par("plt")[c(1,3)][2],
"
[This text is     [this's one]               This text is two inches", 
""))   +
  labs(x = "Culmen Length (mm)")
# [Number of pixels per plot inch x and y: ",dev.size(units="px") * par("plt")[c(2,4)] - par("plt")[c(1,3)] / (par("usr")[c(2,4)] - par("usr")[c(1,3)])[1],"
# --Plot size:", dev.size(units="in") * par("plt")[c(2,4)] - par("plt")[c(1,3)][1],dev.size(units="in") * par("plt")[c(2,4)] - par("plt")[c(1,3)][2],
ggsave(filename = paste0("test.svg"), path = "figures", width  = dev.size("in")[1], height = dev.size("in")[2])
ggsave(filename = paste0("test.png"), path = "figures", width  = dev.size("in")[1], height = dev.size("in")[2])
ggsave(filename = paste0("test.pdf"), path = "figures", width  = dev.size("in")[1], height = dev.size("in")[2])
rm(df)
```

![](figures/test.png)

![](figures/test.pdf)

![](figures/test.svg)

# Setup {data-icon="fa-signal"}

## 

### Data

```{r}
category <- "Ride Hail"
lever <- "Fleet size"
year <- "2018"
y_var <- "logsum_trip_mode_AS_trips"

```

```{r}
print("we are looking at")
print(params$placeExamining)
print("in the year")
print(params$yearExamining)
filenameprefix <- paste0("_",params$placeExamining,"_",params$yearExamining)
print("the y variable is")
y_var <- params[["yvarLIST"]]
print(y_var)
# df[[y_var]] <- params[["yvarLIST"]]
# print(df[[y_var]])
```

## ⌜⎺ ⎺⎺ ⎺⌝

### 

Y var

Which Y variable:
`r params[["yvarLIST"]]`

Title of graphs or the Y var will be:
`r params[["yvarTITLE"]]` The scale of
the Y will be: `r params[["yvarMINmax"]]`
<!-- yvarLIST: "expLogSum" -->
<!-- yvarTITLE: "INEXUS metric" -->
<!-- yvarMINmax: "scale_x_continuous(limits = c(0,1.2))"  -->
In sum, parameters for this run are:
`r params`

Title of graphs or the Y var will be:
`r params[["yvarTITLE"]]` The scale of
the Y will be: `r params[["yvarMINmax"]]`
<!-- yvarLIST: "expLogSum" -->
<!-- yvarTITLE: "INEXUS metric" -->
<!-- yvarMINmax: "scale_x_continuous(limits = c(0,1.2))"  -->
In sum, parameters for this run are:
`r params`
<!-- yvarLIST: "door_to_door_time" -->
<!-- yvarTITLE: "Door to door time to work (min)" -->
<!-- yvarMINmax: "scale_x_continuous(limits = c(0,100))" -->
<!--   yvarLIST: "travelTime" -->
<!-- yvarTITLE: "Travel Time (minutes)" -->
<!-- yvarMINmax: "scale_x_continuous(limits = c(0,100))" -->\
\### datasets are, for the computer i'm
on, here: \# Get the file path for this
computer

```{r}
source( paste0(getwd(),
        "/2022_06_14_global_file_directories.R") )
# returns: 
  print(data_dir_on_this_machine)
```

### open datasets

```{r open_files}
# df_in_a_list   <- read_rds(file =
# paste0(data_dir_on_this_machine,
# "tmp_df_in_a_list22",".rds"))
# df_in_a_list2   <- read_rds(file =
# paste0(data_dir_on_this_machine,
# "tmp_df_in_a_list22.rds"))
# df_merged_from_list   <- read_rds(file =
# paste0(data_dir_on_this_machine,
#        "tmp_df_merged_from_list.rds"))

df_stacked_from_list   <- read_rds(file =
            paste0(data_dir_on_this_machine,
                   "df_stacked_from_list_small.rds"))
description_df   <- read_rds(file =
            paste0(data_dir_on_this_machine,
                   "description_df"))
description_df   <- read_csv(file ="ScenarioTitlesColorsEtc.csv")


```

# What's in the dataset

## 

### scenarios

```{r}
  print(levels(df_stacked_from_list$scenShort))
  print(levels(as_factor(df_stacked_from_list$lever_position)))
  print(levels(df_stacked_from_list$lever))
  print(levels(df_stacked_from_list$category))

```

### variables

```{r}
names(df_stacked_from_list)
```

# Define Labels, Titles, Other

### Titles

### Limits, scales

```{r}
description_df <- description_df |>
  mutate(
    yaxislow =
      case_when(
        variable == "logsum_trip_mode_AS_trips" ~
          median_hilow(df_stacked_from_list$logsum_trip_mode_AS_trips, conf.int =                         .95)[["ymin"]],
        variable == "duration_door_to_door" ~          0
      ),
    yaxishigh =
      case_when(
        variable == "logsum_trip_mode_AS_trips" ~
          median_hilow(df_stacked_from_list[[y_var]], conf.int =
                         .95)[["ymax"]],
        variable == "duration_door_to_door" ~
          median_hilow(df_stacked_from_list$duration_door_to_door, conf.int =
                         .90)[["ymax"]]
        
      ),
    yaxismedian =
      case_when(
        variable == "logsum_trip_mode_AS_trips" ~
          median_hilow(df_stacked_from_list[[y_var]], conf.int =
                         .95)[["y"]],
        variable == "duration_door_to_door" ~
          median_hilow(df_stacked_from_list$duration_door_to_door, conf.int =
                         .95)[["y"]]
      )
  )
```

# List

## 

### delete after change in the other file

```{r}
# df_stacked_from_list <- df_stacked_from_list %>% 
#       mutate(lever_position = 
#                case_when(scenShort == "base" ~ 1,
#                      TRUE ~ as.numeric(lever_position)))
```

### LABELS Names Income etc

```{r fx_LABELS, echo=FALSE}
fx_LABELS <- function(x) {
  x <- x %>%
    mutate(
      l_inc_HiLo10 =
        case_when(
          income10levels == 1 ~ "Lowest 10% Inc ",
          income10levels == 10 ~ "Highest 10% Income ",
          TRUE ~ "Middle 80% Income"
        )
    )
  return(x)
}

# RUN FUNCTION
# df_in_a_list <- map(df_in_a_list, ~ fx_LABELS(.))
# df_merged_from_list <- fx_LABELS(df_merged_from_list)
df_stacked_from_list <- fx_LABELS(df_stacked_from_list)
```

# Summary stats

## 

### 

```{r }
fx_SUMMARY_STATS <- function(df) {
  print(levels(as_factor(df_stacked_from_list$lever_position)))
  print(fct_unique(as_factor(df_stacked_from_list$lever_position)))
  print(levels(df_stacked_from_list$scenShort))
  print(fct_unique(df_stacked_from_list$Short))
  sssumm <- df %>%
    group_by(lever_position) |> 
    summarise(
      avLS = mean(.data[["logsum_trip_mode_AS_trips"]]),
      avY = mean(.data[[y_var]]), 
      n=n()
    )
  print(sssumm)
  sssummQuantiles <- df %>%
    group_by(lever_position) |> 
    summarise(
      avLS = mean(.data[["logsum_trip_mode_AS_trips"]]),
      avY = mean(.data[[y_var]]), 
      qsLS=quantile(.data[["logsum_trip_mode_AS_trips"]]),
      qsTIV=quantile(.data[["duration_total"]], na.rm = TRUE),
      n=n()
    )
  print(sssummQuantiles)
  return(c(sssumm, sssummQuantiles))
}

fx_SUMMARY_STATS(df_stacked_from_list)
```

# Graphs setup

## 

### Colors for divergent

```{r}
color_baseline <- "#EAECCC"
color_transitFreq50p <- "#FDB366"
color_lower_than_baseline <- "#ee3377" # magenta
color_higher_than_baseline <- "#33bbee" # cyan opposite of magenta
color_higher_than_baseline <- "#0077bb" # darker blue

```

### COLORS for the modes

```{r}
# color_scheme_df <- names(df_in_a_list)

description_df <- description_df  %>% 
  mutate(colorOfScenario = case_when(
    str_detect(name_df,"base") ~ color_baseline ,
    str_detect(name_df,"rh") ~ "#ee7733",
    str_detect(name_df,"fq") ~ "#009988",
    str_detect(name_df,"rh") ~ "#0077bb",
    str_detect(name_df,"fq") ~ "#009988"
    
    ) ) |> 
  mutate(alphaOfScenario = lever_position)
print(description_df)

```

### Limits and Scales -- put these in the colors tables?

```{r}
if (requireNamespace("Hmisc", quietly = TRUE))
# yaxislow <- median_hilow(df_stacked_from_list[[y_var]], conf.int=.95)[["ymin"]]
# yaxishigh <- median_hilow(df_stacked_from_list[[y_var]], conf.int=.95)[["ymax"]]
# yaxismedian <- median_hilow(df_stacked_from_list[[y_var]], conf.int=.95)[["y"]]

scenaxis_low <- median_hilow(df_stacked_from_list$lever_position, conf.int=.95)[["ymin"]]
scenaxis_high <- median_hilow(df_stacked_from_list$lever_position, conf.int=.95)[["ymax"]]
scenaxis_median <- median_hilow(df_stacked_from_list$lever_position, conf.int=.95)[["y"]]
```

### Themes

```{r}
theme_set(theme_light(base_size = 11)) # make ALL font based on this
theme_update(plot.title = element_text(face = "bold"),
             legend.justification = "center",
             legend.position = "bottom",
             legend.title = element_blank(),
             legend.text  = element_text(face = "green") +
               scale_color_vibrant() +
               scale_fill_vibrant()  
               # coord_cartesian(xlim = c(yaxislow,yaxishigh))
               
               # scale_color_gradient2(
               #   low = muted("red"),
               #   mid = "white",
               #   high = muted("blue"),
               #   midpoint = "grey",
               # )
             # scale_y_log2()
             # scale_y_continuous(labels = scales::percent)
             # scale_y_continuous(labels = scales::dollar)
             # coord_cartesian(xlim = c(325, 500)
               # theme(panel.background = element_blank()) +
   # theme(panel.border = element_blank(), 
   #       axis.line = element_blank()
         # ,
         # axis.text = element_text(size = rel(1.5))
       # 
  # theme(panel.background = element_rect(colour  = "red")
# Previously used:
      # scale_x_continuous(limits = c(-.05,1.7)) +
  # scale_x_continuous(limits = c(0,1.2)) +
  # scale_x_continuous(limits = c(0,60)) +
)
```

# GRAPHS

## Total {data-icon="fa-signal"}

### Each scenario separately NOT RUN?

```{r gFxTotalWithinDen22, include=FALSE}
gFxTotalWithinDen <- function(df, nm="no name") {
  print(y_var)
  ttcolor_for_scenario <- description_df %>%
    filter(name_df == nm)
  ttcolor_for_scenario <-  ttcolor_for_scenario[["colorOfScenario"]]
  print(paste("for scenario",nm,"the color is",ttcolor_for_scenario))
  # color_for_scenario <- "grey"
  # plot
  plottttt <- g0 +
    geom_density(data = df ,
                 aes(x = .data[[y_var]]),
                 fill = ttcolor_for_scenario,
                 color = ttcolor_for_scenario,
                 alpha = .3) +
    labs(title = nm) 
  # +
  # coord_cartesian(xlim = c(yaxislow,yaxishigh))
  
  # + theme(plot.title = element_text(size = rel(0.5)))
  print(plottttt)
  return(plottttt)
  return(list(g_w_g0 = plottttt,title = nm))
}
# Map
```

## ⌜⎺ ⎺⎺ ⎺⌝

### total for separate datasets

```{r }
# g_total_density <-   map2( .x = df_in_a_list, .y = names(df_in_a_list), ~gFxTotalWithinDen(df = .x, nm = .y)  )
```

### Total for all

# HET

## ⌜⎺ ⎺⎺ ⎺⌝

### Within

```{r echo=FALSE}
fx_Het_WithinScenario <- function(df, y_var, het = "none",
                                  nm = "noName",      ...) {
  yvarTitle <- filter(description_df,variable == y_var)[["Title"]]
  plottttt <- ggplot() +
    geom_density(
      data = df ,
        aes(
          x = .data[[y_var]],
          fill = .data[[het]],
          color = .data[[het]],
          group = .data[[het]]
      ),
      alpha = .3
    ) +
    # layout a lot of graphs
    facet_wrap(facets = df[[het]] , ncol = 3) +
# Now usual
    coord_cartesian(xlim = c(
      filter(description_df, variable == y_var)[["yaxislow"]],
      filter(description_df, variable == y_var)[["yaxishigh"]])) +
    # TITLE
    labs(title = str_glue("{year} {category} {lever}"),
           subtitle = str_glue("Examine {yvarTitle}, with heterogeneity across: {het}")
      ) +
    xlab(filter(description_df, variable == y_var)[["Title"]]) +
    ylab(" density ")
  labs(title = str_glue("{year} {category} {lever}"),
         subtitle = str_glue("Examine {yvarTitle}, with heterogeneity across: {het}")
    )
  # theme(legend.position = "none")
  print(plottttt)
  # ggsave(str_glue("figures/{Sys.Date()}_{nm}_het{het}.png"))
  # ggsave(str_glue("figures/{Sys.Date()}_{nm}_het{het}.pdf"))
  
# width  = dev.size("in")[1], height = dev.size("in")[2])

  return(list(g_w_g0 = plottttt, title = nm))
}

# List of corresponding datasets (maybe filtered)
#   data_inc_HiLo10 <-
#     map(df_in_a_list,
#         ~ .x |>
#           filter(.x[["income10levels"]] == 1 |
#                    .x[["income10levels"]] == 10))
# 
# 
# 
# g_het_loop <- map2(listHet,listHetFilter,
#     function(z,w) imap(w, 
#            ~ fx_Het_WithinScenario(df = .x,
#                                 nm = .y,
#                                 het = z)))
g_het_loop <- map(listHet,
           ~ fx_Het_WithinScenario(y_var = "logsum_trip_mode_AS_trips",
             df = df_stacked_from_list,
                                nm = "scenario",
                                het = .x))
# print(g_het_loop)
```

## 

### Across

```{r}
fx_Het_AcrossScenario <- function(df, y_var, het = "none",
                                  nm = "", tit = "noTitle", 
                                  ...) {
  yvarTitle <- filter(description_df,variable == y_var)[["Title"]]
  plottttt <- ggplot() +
    geom_density(
      data = df ,
        aes(
          x = .data[[y_var]],
          fill = .data[[het]],
          color = .data[[het]],
          group = .data[[het]]
      ),
      alpha = .3
    ) +
# layout a lot of graphs
    facet_wrap(df_stacked_from_list$lever_position, ncol = 3) +
    # facet_wrap(facets = df_stacked_from_list$ownCarYNLabel , ncol = 3) +
# Now usual
    coord_cartesian(xlim = c(
    filter(description_df, variable == y_var)[["yaxislow"]],
    filter(description_df, variable == y_var)[["yaxishigh"]])) +
    # TITLE
    labs(title = str_glue("{year} {category} {lever}"),
           subtitle = str_glue("Examine {yvarTitle}, with heterogeneity across: {het}")
      ) +
    xlab(filter(description_df, variable == y_var)[["Title"]]) +
    ylab(" density ")
  ggsave(str_glue("figures/{Sys.Date()}_{nm}_{y_var}_{het}_{category}_{lever}_{year}.png"))
  ggsave(str_glue("figures/{Sys.Date()}_{nm}_{y_var}_{het}_{category}_{lever}_{year}.pdf"))
  print(plottttt)
  return(list(g_w_g0 = plottttt, title = nm))
}

 g_het_loop_across <- map(
   .x = listY,
   ~ map2(
     .x = .x,
     .y = listHet,
     ~ fx_Het_AcrossScenario(
       df = df_stacked_from_list,
       y_var = .x,
       het = .y,
       nm = "HetAcross"
     )
   )
 )
```

### START AGAIN HERE

```{r}
    facet_wrap(facets = df_stacked_from_list$ownCarYNLabel , ncol = 3) +

```

# Total density compare scenarios {data-icon="fa-signal"}

## ⌜⎺ ⎺⎺ ⎺⌝

### All Scenarios

```{r , echo=FALSE}
titttttttle <- "no cars"
plottttt <- ggplot() +
  # xlab(params$yvarTITLE)  +
  coord_cartesian(xlim = c(yaxislow, yaxishigh)) +
  # coord_cartesian(xlim = c(0, 100)) +
  # scale_color_sunset(
  scale_fill_steps2( 
    # n.breaks = 20,
    low = color_lower_than_baseline,
    mid = "white",
    high = color_higher_than_baseline,
    limits = c(scenaxis_low, scenaxis_high),
    # breaks = c(.125,0.25, .5, 1, 1.5),
    midpoint = .9,
    aesthetics = c("colour")
    ,
    guide = guide_none()
    #   guide_colourbar( size = 0,
    #   # even.steps = FALSE,
    #   # show.limits = TRUE,
    #   barwidth = 0,
    #   barheight = 0
    # )
  ) +
   scale_fill_steps2( 
    # n.breaks = 20,
    low = color_lower_than_baseline,
    mid = "white",
    high = color_higher_than_baseline,
    limits = c(scenaxis_low, scenaxis_high),
    breaks = c(.125,0.25, .5, 1, 1.5),
    midpoint = .9,
    aesthetics = c("fill"), 
    guide = guide_colorsteps(
      even.steps = FALSE,
      show.limits = TRUE,
      barwidth = 16,
      barheight = 0.5
    )   
  ) +
  geom_density(
    data = df_stacked_from_list     
    %>% filter(ownCarYNLabel != "Owns Car") |> 
      filter(lever_position != 1)
    ,
    mapping = aes(x = logsum_trip_mode_AS_trips,
                  colour = lever_position,
                  fill = lever_position,
                  group = lever_position),
    alpha = .8
  )  +
  geom_density(
    data = df_stacked_from_list
    %>% filter(ownCarYNLabel != "Owns Car") |>
      filter(lever_position == 1)
    ,
    mapping = aes(x = logsum_trip_mode_AS_trips),
    color = "white",
    outline.type = "lower",
    fill = "white",
    alpha = .85
      ) +
  labs(title = str_glue("All dist but: {titttttttle})) +
 
  

  ggsave(str_glue("figures/_title.svg"))
  ggsave(str_glue("figures/_title.png"))
  ggsave(str_glue("figures/_title.pdf"))
  

  
plottttt

```

### only lowest and base

```{r , echo=FALSE}
plottttt <- ggplot() +
  xlab(params$yvarTITLE)  +
  coord_cartesian(xlim = c(yaxislow, yaxishigh))    +
  # # Scenario Base
  geom_density(
    data = df_stacked_from_list
    %>% filter(ownCarYNLabel == "Owns Car") |>
      filter(lever_position == 1)
    ,
    mapping = aes(x = logsum_trip_mode_AS_trips,
    colour = factor(lever_position),
    fill = factor(lever_position)),
    alpha = .5
  ) +
  # Scenario 0.25
  geom_density(
    data = df_stacked_from_list |>
      filter(ownCarYNLabel == "Owns Car") |>
      filter(lever_position == 0.25 
             # | lever_position == 1
             )    ,
    mapping = aes(
      x = logsum_trip_mode_AS_trips,
      colour = factor(lever_position),
      fill = factor(lever_position)    ,
      group = factor(lever_position)),
    alpha = .4
  ) +
  # scale_colour_manual("Direction",
  #   values = c("1" = "#33bbee",
  #              "0.25" = color_lower_than_baseline
  #              )  ,
  #   labels = c("1" = "Baseline",
  #              "0.25" = "25% TNC"),
  #   aesthetics =
  #     c("colour", "fill")
  # ) +
  labs(title = str_glue(" Scenario: 0.25 vs baseline;
                          for those who do own cars"))

ggsave(str_glue("figures/basev0p25noCarOwnershipWith.png"),width = 5, height = 4, dpi = 600)

plottttt

```

```{r eval=FALSE, include=FALSE}
plottttt <- ggplot() +
  xlab(params$yvarTITLE)  +
  coord_cartesian(xlim = c(yaxislow, yaxishigh)) +
  # coord_cartesian(xlim = c(-.05,1.7))    +
  # scale_x_continuous(limits = c(-.05,1.7)) +
  # 
  # # Scenario Base
  # geom_density(
  #   data = df_stacked_from_list
  #   %>% filter(ownCarYNLabel != "Owns Car") |>
  #     filter(lever_position == 1)
  #   ,
  #   mapping = aes(x = logsum_trip_mode_AS_trips,
  #   colour = factor(lever_position),
  #   fill = factor(lever_position)),
  #   alpha = .5
  # ) +
  # Scenario 0.25
  geom_density(
    data = df_stacked_from_list |>
      filter(ownCarYNLabel != "Owns Car") |>
      filter(lever_position == 0.25 
             | lever_position == 1
             )    ,
    mapping = aes(
      x = (logsum_trip_mode_AS_trips),
      colour = factor(lever_position),
      fill = factor(lever_position)    ,
      group = factor(lever_position)),
    alpha = .3
  ) 
# +
#   scale_colour_manual("Direction",
#     values = c("1" = "#33bbee",
#                "0.25" = color_lower_than_baseline
#                )  ,
#     labels = c("1" = "Baseline",
#                "0.25" = "25% TNC"),
#     aesthetics =
#       c("colour", "fill")
  # )

plottttt
```

```{r eval=FALSE, , echo=FALSE, include=FALSE}
cols <- c("8" = "red", "4" = "blue", "6" = "darkgreen", "10" = "orange")

p <- ggplot(
   mtcars,
   aes(mpg, wt, colour = factor(cyl), fill = factor(cyl))
 ) +
   geom_point(shape = 21, alpha = 0.5, size = 2) 
p
p + 
   scale_colour_manual(
     values = cols,
     aesthetics = c("colour", "fill")
   )
p
p + scale_colour_manual(values = cols)
# And limits to control the possible values of the scale
p + scale_colour_manual(values = cols, limits = c("4", "8"))
p + scale_colour_manual(values = cols, limits = c("4", "6", "8", "10"))

p + scale_colour_manual(
  values = cols,
  breaks = c("4", "6", "8"),
  labels = c("four", "six", "eight")
)
```

```{r}
# plot(exp_trans(0.5), xlim = c(-2, 2))
# plot(exp_trans(1), xlim = c(-2, 2))
# plot(exp_trans(2), xlim = c(-2, 2))
# plot(exp_trans(), xlim = c(-2, 2))
# plot(probit_trans(), xlim = c(0, 2))
# plot(modulus_trans(2), xlim = c(0, 2))
# dist_normal(mu = 0, sigma = 1)
# Arguments
# (mu = 0, sigma = 1)
# plot(probability_trans(distribut   dist_normal()),xlim = c(0,2))
# 
# 
#   scale_fill_gradientn(colours=fill.colors, 
#                        trans = 'norm', 
#                        breaks = quantile(dat$z, probs = c(0, 0.25, 1))
#   )

```

```{r gTotalWithinDen}
g0 + 
  geom_density(data = df_stacked_from_list,
               mapping = aes(x=logsum_trip_mode_AS_trips, 
                             color = scenBind,
                             fill = scenBind,
                             group = scenBind),
               alpha = 0.2)
```

```{r gTotalWithinDenBase, include=FALSE, cache=FALSE}
# g_total_density_baseline <- map("baseline",~gFxTotalWithinDen(df_in_a_list[["df_base"]], 
#                                     titleOfGraph = ., coloring = "gray")     )
```

<!-- ## Column 2 {data-width="350"} -->

<!-- ### chart cc -->

<!-- ```{r} -->

<!-- g_total_density_baseline[[1]][["g_w_g0"]] -->

<!-- ``` -->

<!-- can tell the ride manager -->

<!-- population file -->

<!-- telecommuting --  -->

```{r, include=FALSE}
# g_total_density
# names(g_total_density)
# View(g_total_density)
# li_graphs <- list('g_total_density_baseline[[1]][["g_w_g0"]]',
#                   'g_total_density[[2]][["g_w_g0"]]',
#                   'g_total_density[[3]][["g_w_g0"]]',
#                   'g_total_density[[4]][["g_w_g0"]]',
#                   'g_total_density[[5]][["g_w_g0"]]'
# )
```

### Example ridge

```{r ex}
ggplot(iris, aes(x = Sepal.Length, y = Species)) + geom_density_ridges()
```

# END OF KNITTER

```{r}
1 + 1
knitr::knit_exit()
```

## ⌜⎺ ⎺⎺ ⎺⌝

```{r include=FALSE}
# baseline <-  g_total_density[[1]][["g_proto"]] 
#   baseline[["aes_params"]][["fill"]] <- '#ee7733'
#   baseline[["aes_params"]][["colour"]] <- '#ee7733'
#   baseline[["aes_params"]][["alpha"]] <- .3

# color_baseline

gFxTotalBaseVsX <-   function(x,titleOfGraph="no name",coloring = "#33bbee") {
  plotttt <-  g0 +
    # baseline   +
    geom_density(data = x ,
               aes(x = df[[y_var]]),
               fill = coloring,
               color = coloring,
               alpha = .3 )    +
    labs(title = paste0("Baseline vs. ", titleOfGraph))  +
    scale_color_gradient2(
                 low = color_lower_than_baseline,
                 mid = color_baseline,
                 high = color_higher_than_baseline,
                 midpoint = color_baseline
               )
  # +
  #   theme(plot.title = element_text(size = rel(0.5)))
  print(plotttt)
  return(list(g_w_g0 = plotttt, title = titleOfGraph)) 
}

```

### Compare Across Scenarios

```{r totalLayer}
g_baseVsOther_total <- 
  map(names(df_in_a_list),
      ~gFxTotalBaseVsX(df_in_a_list[[.]],
                                    .)     )
# g_baseVsOther_total
```

<!-- ## ⌜⎺ ⎺⎺ ⎺⌝ -->

<!-- ### patchwork total individual -->

<!-- ```{r g_all_totals, fig.height=3, fig.width=2} -->

<!-- (g_total_density_baseline[[1]][["g_w_g0"]] | -->

<!--    g_total_density_baseline[[1]][["g_w_g0"]] | -->

<!--    g_total_density[[2]][["g_w_g0"]] ) / -->

<!-- (g_total_density[[3]][["g_w_g0"]] | -->

<!--    g_total_density[[4]][["g_w_g0"]] | -->

<!--           g_total_density[[5]][["g_w_g0"]]  ) -->

<!-- ``` -->

<!-- ### patchwork compare across -->

<!-- ```{r gMultFxTotalWithinDeneee} -->

<!-- # names("g_baseVsOther_total") -->

<!-- g_baseVsOther_total[[1]][["g_w_g0"]] + -->

<!--           g_baseVsOther_total[[2]][["g_w_g0"]] + -->

<!--           g_baseVsOther_total[[3]][["g_w_g0"]] + -->

<!--           g_baseVsOther_total[[4]][["g_w_g0"]] + -->

<!--           g_baseVsOther_total[[5]][["g_w_g0"]]  -->

<!-- ``` -->

## ░░░░░░░░░░░░░░░░░░░

# Income {data-icon="fa-signal"}

```{r  include=FALSE}
fxHiLoWithinDen <- function(x,titleOfGraph="no name") {
 
  # partial gg graph elements
  # LINE ONLY for middle ONLY
  tmpPartGG <-
    geom_density(data = x %>% filter(income10levels!= 1 |
                                              income10levels!=10),
                 aes(x=df[[y_var]]),
                 color = "#BBBBBB",
                 alpha = .3
    )
  # FILL and color for high and lo
  tmpPartGG2 <-
      geom_density(data = xWlabels %>% filter(income10levels == 1 |
                                              income10levels==10) ,
               aes(x=df[[y_var]],
                   fill = l_inc_HiLo10,
                   color = l_inc_HiLo10,
                   group = l_inc_HiLo10),
               alpha = .3
               )
  # the whole graph, with title
  plottttt <- g0 + tmpPartGG + tmpPartGG2 +
    labs(title = titleOfGraph) +
    theme(legend.position = "none")
  print(plottttt)


  return(plottttt)
  return(titleOfGraph)
}
```

```{r fxHiLoWithinDen2, include=FALSE}
# df_stacked_from_list <- df_stacked_from_list %>%
      # mutate(l_inc_HiLo10 =
      #       case_when(income10levels==1 ~ " Lowest 10% Inc ",
      #                 income10levels==10 ~ " Highest 10% Income ",
      #                 TRUE ~ "middle 80% income "))
# Should move these labels before merge and bind
```

## ⌜⎺ ⎺⎺ ⎺⌝ {data-width="1"}

### ridges

```{r ridges, include=TRUE}
# g0 +
#   geom_density_ridges(data = df_stacked_from_list ,
#                aes(x= df[[y_var]],
#                    y = scen,
#                    fill = l_inc_HiLo10,
#                    color = l_inc_HiLo10,
#                    group = scen),
#                alpha = .3
#                )

```

## ⌜⎺ ⎺⎺ ⎺⌝ {data-width="5"}

### Highest Lowest 10%

```{r gg_HiLoWithinDen2, include=TRUE}
g_HiLoWithinDen <- map(names(df_in_a_list),
                        ~fxHiLoWithinDen(df_in_a_list[[.]],
                                    .)     )
# g_HiLoWithinDen
```

<!-- ## ⌜⎺ ⎺⎺ ⎺⌝ {data-width="3"} -->

<!-- ### Patchwork -->

<!-- ```{r gMultFxIncWithinDen, include=TRUE} -->

<!-- (g_HiLoWithinDen[[1]] |  -->

<!--    g_HiLoWithinDen[[1]] | -->

<!--    g_HiLoWithinDen[[2]] ) / -->

<!-- (g_HiLoWithinDen[[3]]|  -->

<!--    g_HiLoWithinDen[[4]] | -->

<!--           g_HiLoWithinDen[[5]]  ) -->

<!-- ``` -->

## ░░░░░░░░░░░░░░░░░░░

# Delta

DELTA : for each person, how the
`r params[["yvarLIST"]]` changes across
different scenarios for EACH PERSON
(dataframe merged by person id)

```{r g1Base, include=FALSE}
(g1 <- df_merged_from_list %>% 
   ggplot() +
 scale_x_continuous(limits = c(-5,5)) +
  # scale_x_continuous(limits = c(0,60)) +
   theme_bw() +
  scale_fill_vibrant() +
  scale_color_vibrant() +
   theme(panel.border = element_blank(), axis.line = element_blank()) 
)
```

```{r Fxhist_delta, include=FALSE}
# yvar = df_merged_from_list[["deltaLS_RHsz1p75"]]

filler <- "l_inc_HiLo10"
fxgBetterWorseSame <- function(x,titleOfGraph="no name",coloring = "#33bbee") {
  df[[y_var]] = dftemp[[x]]
  # zfill = df_merged_from_list[[betterWorse_RHsz1p75]]
 ga <- dftemp %>% 
    # filter(income10levels == 1 |
    # income10levels == 10) %>%
  ggplot() +
    scale_x_continuous(limits = c(-.4,.4)) +
    scale_y_continuous(limits = c(0,20000)) +
    geom_histogram(
                   aes(x = df[[y_var]], 
                       fill = l_inc_HiLo10),
                   alpha = 0.5,
                   binwidth = .04,
                   boundary = .04) +
    geom_histogram(data = dftemp %>%  
                     filter(df[[y_var]] == 0)  , 
                   aes(x = deltaLS_RHsz1p75, 
                       colour = "Same"),
                   alpha = 0.3,
                   binwidth = .08,
                   color = "grey",
                   fill = "grey") +
    scale_colour_manual( values = c("Same" = "grey")) +
      labs(title = titleOfGraph)

}
```

```{r hist_delta2, include=FALSE}
dftemp <- df_merged_from_list
map(li_delta_vars, ~fxgBetterWorseSame(.,paste0(., " Better, Worse, or the Same in the given Scenario")))
dftemp <- df_merged_from_list %>% 
  filter(income10levels == 1 |     income10levels == 10)
map(li_delta_vars, ~fxgBetterWorseSame(.,paste0(., " Better, Worse, or the Same in the given Scenario")))
dftemp <- df_merged_from_list %>% 
  filter(mode_5categories_df_base == "ride_hail" )
map(li_delta_vars, ~fxgBetterWorseSame(.,paste0(., " Better, Worse, or the Same in the given Scenario")))
```

## ⌜⎺ ⎺⎺ ⎺⌝

### Better worse same by mode

```{r}
# fxgBetterWorseSame <- function(x,titleOfGraph="no name",coloring = "#33bbee") {
#   df[[y_var]] = dftemp[[x]]
#   # zfill = df_merged_from_list[[betterWorse_RHsz1p75]]
#  ga <- dftemp %>% 
#     # filter(income10levels == 1 |
#     # income10levels == 10) %>%
#   ggplot() +
#     scale_x_continuous(limits = c(-.4,.4)) +
#     scale_y_continuous(limits = c(0,20000)) +
#     geom_histogram(
#                    aes(x = df[[y_var]], 
#                        fill = l_inc_HiLo10),
#                    alpha = 0.5,
#                    binwidth = .04,
#                    boundary = .04) +
#     geom_histogram(data = dftemp %>%  
#                      filter(df[[y_var]] == 0)  , 
#                    aes(x = deltaLS_RHsz1p75, 
#                        colour = "Same"),
#                    alpha = 0.3,
#                    binwidth = .08,
#                    color = "grey",
#                    fill = "grey") +
#     scale_colour_manual( values = c("Same" = "grey")) +
#       labs(title = titleOfGraph)

  #  ggplot(df_merged_from_list) +
  #   scale_x_continuous(limits = c(-.4,.4)) +
  #   scale_y_continuous(limits = c(0,20000)) +
  #   geom_histogram(aes(x = deltaLS_RHsz1p75)) +
  # facet_wrap(as.factor(df_merged_from_list[["mode_5categories_df_base"]]))

# }
```

```{r hist_delta, include=TRUE, cache=FALSE}
for (xvar in c("deltaLS_RHsz0p125", "deltaLS_RHsz1p75" )) {
      
  tmp <- ggplot(df_merged_from_list) +
    scale_x_continuous(limits = c(-.4, .4)) +
    scale_y_continuous(limits = c(0, 20000)) +
    geom_histogram(aes(x = df_merged_from_list[[xvar]])) +
    labs(title = xvar) +
    facet_wrap(as.factor(df_merged_from_list[["mode_5categories_df_base"]])
    )
  
  print(tmp)


}
```

### Better worse same table

```{r tablesBetterWorseSame}


flextable(df_merged_from_list %>% 
  group_by(mode_5categories_df_base) %>% 
  summarise(countsMode = n(),
            detlalogsum175 = mean(deltaLS_RHsz1p75) ,
            detlalogsum0125 = mean(deltaLS_RHsz0p125)) %>%
  arrange(desc(countsMode)) %>% 
  ungroup() )

flextable(df_merged_from_list %>% 
  group_by(mode_5categories_df_RH_sz_0p125) %>% 
  summarise(countsMode = n(),
            detlalogsum = mean(deltaLS_RHsz0p125)) %>% 
  arrange(desc(countsMode)) %>% 
  ungroup() )
flextable(df_merged_from_list %>% 
  group_by(mode_5categories_df_RH_sz_1p75) %>% 
  summarise(countsMode = n(),
            detlalogsum = mean(deltaLS_RHsz1p75)) %>%
  arrange(desc(countsMode)) %>% 
  ungroup() )
```

<https://bookdown.org/yihui/rmarkdown-cookbook/>
<https://stackoverflow.com/questions/40563479/relationship-between-r-markdown-knitr-pandoc-and-bookdown>

oooh:
<https://ardata-fr.github.io/flextable-book/get-flextable-from-objects.html#dataset-summary>

### better worse same dist

```{r dens_delta}
g1 + 
  geom_density(aes(x = deltaLS_RHsz0p125),
                 color = "yellow",
                 fill = "yellow") +
  scale_x_continuous(limits = c(-2,2))
```

### b

```{r dens_delta233}
gtm <- df_merged_from_list %>%
      mutate(l_inc_HiLo10 =
            case_when(income10levels==1 
                      ~ " Lowest 10% Inc ",
                      income10levels==10 
                      ~ " Highest 10% Income ",
                      TRUE ~ "middle 80% income ")) %>% 
            ggplot() + 
              geom_density(aes(x = log2(deltaLS_RHsz0p125), 
                               color = l_inc_HiLo10)) +
              scale_x_continuous(limits = c(-8,3))
gtm
```

<https://ardata-fr.github.io/flextable-book/index.html>

## ⌜⎺ ⎺⎺ ⎺⌝ {data-width="5"}

## Better worse Same by income and Mode

```{r dens_delta_mode, cache=FALSE}
gtm +
  facet_wrap("mode_5categories_df_base")
```

## ░░░░░░░░░░░░░░░░░░░

# Misc summary

## ⌜⎺ ⎺⎺ ⎺⌝

### income

```{r g_incTime}
df_merged_from_list %>% 
      filter(income10levels==1 |  income10levels==10) %>% 
  ggplot(aes(x=door_to_door_time_df_base))+
  scale_x_continuous(limits = c(0,200)) +
  geom_histogram(bins = 20) +
  facet_wrap("l_inc_HiLo10")
```

## ░░░░░░░░░░░░░░░░░░░

# Modes

## ⌜⎺ ⎺⎺ ⎺⌝

### m

```{r g_Mode_frq}
summ_df_mode <- df_merged_from_list %>%
  group_by(mode_5categories_df_base) %>%
  summarise(countsMode = n()) %>%
  arrange(desc(countsMode)) %>%
  ungroup
print(summ_df_mode)
```

### m

```{r g_Mode_frq2}
summ_df_mode2 <- df_merged_from_list %>%
  group_by(mode_5categories_df_RH_sz_0p125) %>%
  summarise(countsMode2 = n()) %>%
  arrange(desc(countsMode2)) %>%
  ungroup
print(summ_df_mode2)
```

### m

```{r g_Mode_frq3,  cache=FALSE}
summ_df_mode3 <- df_merged_from_list %>%
  group_by(mode_5categories_df_RH_sz_0p125, changeMode_RHsz0p125) %>%
  summarise(countsMode3 = n()) %>%
  arrange(desc(countsMode3)) %>%
  ungroup
print(summ_df_mode3)
flextable(summ_df_mode3)
```

## ⌜⎺ ⎺⎺ ⎺⌝

### changes in modes

<https://bookdown.org/yihui/bookdown/figures.html>

```{r g_Mode_frq4, out.width="600px", fig.width=15, fig.height=3.2}

g_Mode_frq4 <-
  ggplot(data = summ_df_mode, 
         aes(x = reorder(mode_5categories_df_base, -countsMode) , 
             y=countsMode, 
             fill=mode_5categories_df_base)) +
  geom_bar(stat = "identity", 
           alpha = 0.3) +
    theme_bw() 
ggsave(paste0("figures/",Sys.Date(),
                "g_Mode_frq4gg.png"), type = "cairo",
       dpi = 600, width = 10, height = 4*.8) 

print(g_Mode_frq4)
knitr::include_graphics(paste0("figures/",Sys.Date(),
"g_Mode_frq4-1.png" ))
knitr::include_graphics(paste0("figures/",Sys.Date(),
                "g_Mode_frq4gg.png" ))


```

<https://clauswilke.com/dataviz/multi-panel-figures.html>
<https://www.rstudio.com/resources/webinars/a-gentle-introduction-to-tidy-statistics-in-r/>
<https://r4ds.had.co.nz/graphics-for-communication.html#saving-your-plots>

actually helpful:
<https://benjaminlouis-stat.fr/en/blog/2020-05-21-astuces-ggplot-rmarkdown/>

oh here actually actually helpful
<https://yihui.org/knitr/options/#plots>
size: ('normalsize'; character)

## next

### misc

```{r g_Mode_frq5}
ggplot() +
  geom_bar(data = summ_df_mode, 
           aes(x = reorder(as.factor(mode_5categories_df_base), 
                           -countsMode) , 
               y=countsMode),
           fill = "grey",
           alpha = 0.3,
           stat = "identity") +
  geom_bar(data = summ_df_mode2, 
           aes(x = reorder(as.factor(mode_5categories_df_RH_sz_0p125), 
                           -countsMode) , 
               y=countsMode, 
             fill=as.factor(mode_5categories_df_RH_sz_0p125)),
           fill = "green",
           alpha = 0.3,
           stat = "identity") 
    
```

## ⌜⎺ ⎺⎺ ⎺⌝ {data-width="5"}

### misc

```{r g_Mode_frq6, cache=FALSE}
ggplot() +
 geom_bar(data = summ_df_mode3, 
           aes(x = reorder(as.factor(mode_5categories_df_RH_sz_0p125), 
                           -countsMode) , 
               y=countsMode, 
             fill=as.factor(changeMode_RHsz0p125)),
           alpha = 0.3,
           stat = "identity") +
    theme_bw() 

```

## ░░░░░░░░░░░░░░░░░░░

# Who changed

## ░░░░░░░░░░░░░░░░░░░

# Car Own

```{r fxCarOwnWithinDen, include=FALSE, cache=FALSE}
fxCarOwnWithinDen <- function(x,titleOfGraph="no name") {
# Car Ownership labels
  plottttt <- g0 +
    geom_density( data = x ,
                  aes(x=df[[y_var]],
                      fill = ownCarYNLabel,
                      color = ownCarYNLabel,
                      group = ownCarYNLabel),
                  alpha = .3
    ) +
    labs(title = titleOfGraph) +
    # theme(legend.position = "none")
    # scale_y_continuous(limits = c(0,1.8))
  print(plottttt)
  return(plottttt)
}
```

## ⌜⎺ ⎺⎺ ⎺⌝ {data-width="5"}

### Ownership Within

```{r gg_CarOwnWithinDen, cache=FALSE}
g_CarOwnWithinDens <- map(names(df_in_a_list),
                        ~fxCarOwnWithinDen(df_in_a_list[[.]],
                                    .)     )
g_CarOwnWithinDens
```

## ⌜⎺ ⎺⎺ ⎺⌝ {data-width="3"}

### patchwork

```{r gMultFxCarOwnWithinDen}
(g_CarOwnWithinDens[[1]] | 
   g_CarOwnWithinDens[[1]] |
   g_CarOwnWithinDens[[2]] ) /
(g_CarOwnWithinDens[[3]]| 
   g_CarOwnWithinDens[[4]] |
          g_CarOwnWithinDens[[5]]  )

```

## ░░░░░░░░░░░░░░░░░░░

# Stacked

## ⌜⎺ ⎺⎺ ⎺⌝

### density Income

```{r dens_delta2}
gtm <- df_stacked_from_list %>%
            ggplot() + 
              geom_density(aes(x = df[[y_var]], 
                               color = l_inc_HiLo10)) +
              scale_x_continuous(limits = c(-.1,2))  + 
  facet_wrap("scenShort")
gtm
```

## ░░░░░░░░░░░░░░░░░░░

# Summary Stats

## ⌜⎺ ⎺⎺ ⎺⌝

### 

```{r}
df_stacked_from_list %>%
  group_by(scenShort, mode_choice_actual_5) %>% 
  summarise(counts = n()) 
```

## ░░░░░░░░░░░░░░░░░░░

# Scratch

## Across

```{r layer}

  baseline <-  g_total_density[[1]][["g_proto"]] 
  baseline[["aes_params"]][["fill"]] <- '#ee7733'
  baseline[["aes_params"]][["colour"]] <- '#ee7733'
  baseline[["aes_params"]][["alpha"]] <- .3

color_baseline

gFxTotalBaseVsX <-   function(x,titleOfGraph="no name",coloring = "#33bbee") {
  plotttt <-  g0 +
    baseline   +
    geom_density(data = x ,
               aes(x = df[[y_var]]),
               fill = coloring,
               color = coloring,
               alpha = .3 )    +
    labs(title = paste0("Baseline vs. ", titleOfGraph)) +
    theme(plot.title = element_text(size = 9))
  return(list(g_w_g0 = plotttt, title = titleOfGraph)) 
}

# Map

g_baseVsOther_total <- 
  map(names(df_in_a_list),
                        ~gFxTotalBaseVsX(df_in_a_list[[.]],
                                    .)     )
g_baseVsOther_total

```

```{r gMultFxTotalWithinDeneee}
g_baseVsOther_total[[1]][["g_w_g0"]] +
          g_baseVsOther_total[[2]][["g_w_g0"]] +
          g_baseVsOther_total[[3]][["g_w_g0"]] +
          g_baseVsOther_total[[4]][["g_w_g0"]] +
          g_baseVsOther_total[[5]][["g_w_g0"]] 

```

## Labels

# GRAPHS - Distribution

Within Graphs: Within Scenarios (one
graph per scenario)

```{r gMultFxTotalWithinDen}
(g_total_density_baseline[[1]][["g_w_g0"]] | 
   g_total_density_baseline[[1]][["g_w_g0"]] |
   g_total_density[[2]][["g_w_g0"]] ) /
(g_total_density[[3]][["g_w_g0"]] | 
   g_total_density[[4]][["g_w_g0"]] |
          g_total_density[[5]][["g_w_g0"]]  )



```

### c

```{r g_deltaLogsum}
g_temp <- g1 +
  geom_histogram(aes(x = logsum_trip_mode_AS_trips_df_base),
                 bins = 250,
                 color = "#BBBBBB",
                 fill = "#BBBBBB") 
print(g_temp)
```

### d

```{r g_de555}
g_temp2 <-  g1 + 
  geom_density(aes(x = exp(logsum_trip_mode_AS_trips_df_base)),
                 color = "#BBBBBB",
                 fill = "#BBBBBB")
print(g_temp2)
```

## ⌜⎺ ⎺⎺ ⎺⌝

### e

```{r g_, cache=FALSE}
g_temp3 <-  g1 + 
  geom_density(aes(x = exp(logsum_trip_mode_AS_trips_df_RH_sz_0p125)),
                 color = "yellow",
                 fill = "yellow") +
    scale_x_continuous(limits = c(-.1,1.8))
print(g_temp3)
```

```{r eval=FALSE, include=FALSE}
# g1 + 
#   geom_density(aes(x = ),
#                  color = "yellow",
#                  fill = "yellow") +
#   scale_x_continuous(limits = c(-.01,1.5))
# 
# df_merged_from_list %>%
#       mutate(l_inc_HiLo10 =
#             case_when(income10levels_df_base==1 
#                       ~ " Lowest 10% Inc ",
#                       income10levels==10 
#                       ~ " Highest 10% Income ",
#                       TRUE ~ "middle 80% income ")) %>% 
#   ggplot() + 
#   geom_density( 
#                    color = l_inc_HiLo10)) +
#   scale_x_continuous(limits = c(-.05,.05))

  


```

### f

```{r}
g1 + 
    scale_x_continuous(limits = c(-.5,3)) +
  geom_point(data = df_merged_from_list,
    aes(x = deltaLS_RHsz1p75,
        y = income_in_thousands,
        color = factor(mode_5categories_df_base))) +
  scale_fill_vibrant() +
  scale_color_vibrant() 
```

## ⌜⎺ ⎺⎺ ⎺⌝

### g

```{r}
g1 + 
  geom_density(aes(x = logsum_trip_mode_AS_trips_df_base),
                 color = "black") +
  geom_density(aes(x = logsum_trip_mode_AS_trips_df_RH_sz_0p125),
               color = "yellow",
               fill = "yellow",
               alpha = 0.3
               )
```

###h

```{r}
# df[[y_var]] <- df_merged_from_list[["deltaLogsum_base_vs_RH_sz_0p125"]]
# coloring <- "blue"
# titleOfGraph <- "Logsum of Ridehail 12.5% Relative to Baseline"
#
#
#
# g0 +
#   geom_density(data = df_merged_from_list ,
#                aes(x = "deltaLogsum_base_vs_RH_sz_0p125"))
#
# ,
#                fill = coloring,
#                color = coloring,
#                alpha = .3
#                ) +
#   labs(title = titleOfGraph) +
#   theme(plot.title = element_text(size = 9))
```

### NOTES

```{r table}
df_merged_from_list %>% 
  group_by(mode_5categories_df_base) %>% 
  summarise(countsMode = n(),
            detlalogsum = mean(deltaLS_RHsz1p75)) %>%
  arrange(desc(countsMode)) %>% 
  ungroup() 

df_merged_from_list %>% 
  group_by(mode_5categories_df_RH_sz_0p125) %>% 
  summarise(countsMode = n(),
            detlalogsum = mean(deltaLS_RHsz0p125)) %>% 
  arrange(desc(countsMode)) %>% 
  ungroup() 
```

```{r dens_delta44}
g1 + 
  geom_density(aes(x = deltaLS_RHsz0p125),
                 color = "yellow",
                 fill = "yellow") +
  scale_x_continuous(limits = c(-.01,1.5))

gtm <- df_merged_from_list %>%
      mutate(l_inc_HiLo10 =
            case_when(income10levels==1 
                      ~ " Lowest 10% Inc ",
                      income10levels==10 
                      ~ " Highest 10% Income ",
                      TRUE ~ "middle 80% income ")) %>% 
ggplot() + 
  geom_density(aes(x = exp(deltaLS_RHsz0p125), 
                   color = l_inc_HiLo10)) +
  scale_x_continuous(limits = c(-.05,.05))

gtm +
  facet_wrap("mode_5categories_df_base")

  


```

# misc

<https://www.christophenicault.com/post/understand_size_dimension_ggplot2/>
<https://www.r-bloggers.com/>

Methods:
<https://egap.org/methods-guides/>

```{r g_incTim33e}
df_merged_from_list %>% 
  ggplot(aes(x=door_to_door_time_df_base,
             fill = factor(income10levels)))+
  scale_x_continuous(limits = c(0,650)) +
  geom_histogram(bins = 20) +
  theme_bw()  
```

```{r g_Mode_frq333}
summ_df_mode <- df_merged_from_list %>%
  group_by(mode_5categories_df_base) %>%
  summarise(countsMode = n()) %>%
  arrange(desc(countsMode)) %>%
  ungroup
print(summ_df_mode)

summ_df_mode2 <- df_merged_from_list %>%
  group_by(mode_5categories_df_RH_sz_0p125) %>%
  summarise(countsMode = n()) %>%
  arrange(desc(countsMode)) %>%
  ungroup
print(summ_df_mode2)

summ_df_mode3 <- df_merged_from_list %>%
  group_by(mode_5categories_df_RH_sz_0p125, changeMode_RHsz0p125) %>%
  summarise(countsMode = n()) %>%
  arrange(desc(countsMode)) %>%
  ungroup
print(summ_df_mode3)

gmodettt <-
  ggplot(data = summ_df_mode, 
         aes(x = reorder(mode_5categories_df_base, -countsMode) , 
             y=countsMode, 
             fill=mode_5categories_df_base)) +
  geom_bar(stat = "identity", 
           alpha = 0.3) +
    theme_bw() 
print(gmodettt)


  
  ggplot() +
  geom_bar(data = summ_df_mode, 
           aes(x = reorder(as.factor(mode_5categories_df_base), 
                           -countsMode) , 
               y=countsMode),
           fill = "grey",
           alpha = 0.3,
           stat = "identity") +
  geom_bar(data = summ_df_mode2, 
           aes(x = reorder(as.factor(mode_5categories_df_RH_sz_0p125), 
                           -countsMode) , 
               y=countsMode, 
             fill=as.factor(mode_5categories_df_RH_sz_0p125)),
           fill = "grey",
           alpha = 0.3,
           stat = "identity") +
    theme_bw() 
  
    ggplot() +
 geom_bar(data = summ_df_mode3, 
           aes(x = reorder(as.factor(mode_5categories_df_RH_sz_0p125), 
                           -countsMode) , 
               y=countsMode, 
             fill=as.factor(changeMode_RHsz0p125)),
           alpha = 0.3,
           stat = "identity") +
    theme_bw() 

```

```{r g_deltaLogsumeew}
g_temp <- g1 +
  geom_histogram(aes(x = logsum_trip_mode_AS_trips_df_base),
                 bins = 250,
                 color = "#BBBBBB",
                 fill = "#BBBBBB") 
print(g_temp)


g_temp2 <-  g1 + 
  geom_density(aes(x = exp(logsum_trip_mode_AS_trips_df_base)),
                 color = "#BBBBBB",
                 fill = "#BBBBBB")
print(g_temp2)

g_temp3 <-  g1 + 
  geom_density(aes(x = exp(logsum_trip_mode_AS_trips_df_RH_sz_0p125)),
                 color = "yellow",
                 fill = "yellow") +
    scale_x_continuous(limits = c(-.1,1.8))
print(g_temp3)
```

```{r}
# g1 + 
#   geom_density(aes(x = ),
#                  color = "yellow",
#                  fill = "yellow") +
#   scale_x_continuous(limits = c(-.01,1.5))
# 
# df_merged_from_list %>%
#       mutate(l_inc_HiLo10 =
#             case_when(income10levels_df_base==1 
#                       ~ " Lowest 10% Inc ",
#                       income10levels==10 
#                       ~ " Highest 10% Income ",
#                       TRUE ~ "middle 80% income ")) %>% 
#   ggplot() + 
#   geom_density( 
#                    color = l_inc_HiLo10)) +
#   scale_x_continuous(limits = c(-.05,.05))

  


```

```{r}
g1 + 
    scale_x_continuous(limits = c(-.5,3)) +
  geom_point(data = df_merged_from_list,
    aes(x = deltaLS_RHsz1p75,
        y = income_in_thousands,
        color = factor(mode_5categories_df_base))) +
  scale_fill_vibrant() +
  scale_color_vibrant() 
```

```{r}
g1 + 
  geom_density(aes(x = logsum_trip_mode_AS_trips_df_base),
                 color = "black") +
  geom_density(aes(x = logsum_trip_mode_AS_trips_df_RH_sz_0p125),
               color = "yellow",
               fill = "yellow",
               alpha = 0.3
               )
```

```{r}
# df[[y_var]] <- df_merged_from_list[["deltaLogsum_base_vs_RH_sz_0p125"]]
# coloring <- "blue"
# titleOfGraph <- "Logsum of Ridehail 12.5% Relative to Baseline"
#
#
#
# g0 +
#   geom_density(data = df_merged_from_list ,
#                aes(x = "deltaLogsum_base_vs_RH_sz_0p125"))
#
# ,
#                fill = coloring,
#                color = coloring,
#                alpha = .3
#                ) +
#   labs(title = titleOfGraph) +
#   theme(plot.title = element_text(size = 9))
```

# to read about sizing

<https://rmd4sci.njtierney.com/figures-tables-captions-.html>

```{r}
ggsave(
  filename = "foo300.png",
  ggplot(mtcars, aes(x = wt, y = mpg)) +
    geom_point(size = 2, shape = 23) + 
    theme_bw(base_size = 10),
  width = 5,
  height = 4,
  dpi = 300,
  units = "in",
  device = 'png'
)


ggsave(
  filename = "foo150.png",
  ggplot(mtcars, aes(x = wt, y = mpg)) +
    geom_point(size = 2, shape = 23) + 
    theme_bw(base_size = 10),
  width = 10,
  height = 8,
  dpi = 150,
  units = "in",
  device = 'png'
)

```

# interactive plots

<https://holtzy.github.io/Pimp-my-rmd/#interactive_graphics>

```{r}
library(ggplot2)
library(plotly)
library(gapminder)
 
p <- gapminder %>%
  filter(year==1977) %>%
  ggplot( aes(gdpPercap, lifeExp, size = pop, color=continent)) +
  geom_point() +
  scale_x_log10() +
  theme_bw()
 
ggplotly(p)
```

# tables

knitr::kable(iris2, caption = "An example
table caption.") \## kable extra
<https://haozhu233.github.io/kableExtra/awesome_table_in_html.html#Grouped_Columns__Rows>

```{r}
fffffsadfas <- mtcars[1:5, 1:6]
kbl(fffffsadfas)
dt %>%
  kbl() %>%
  kable_styling()
kbl(dt) %>%
  kable_styling(bootstrap_options = "striped", full_width = F, position = "left")
```

```{r}
mtcars[1:8, 1:8] %>%
  kbl() %>%
  kable_paper(full_width = F) %>%
  column_spec(2, color = spec_color(mtcars$mpg[1:8]),
              link = "https://haozhu233.github.io/kableExtra/") %>%
  column_spec(6, color = "white",
              background = spec_color(mtcars$drat[1:8], end = 0.7),
              popover = paste("am:", mtcars$am[1:8]))
```

```{r}
kbl(dt) %>%
  kable_classic() %>%
  add_header_above(c(" " = 1, "Group 1" = 2, "Group 2" = 2, "Group 3" = 2))
```

```{r}
kbl(cbind(mtcars, mtcars)) %>%
  kable_paper() %>%
  scroll_box(width = "500px", height = "200px")
```

## stargazer

```{r}
stargazer(attitude, type = "html")

```

## Datatables with

```{r}
library(DT)
datatable(mtcars, rownames = FALSE, filter="top", options = list(pageLength = 5, scrollX=T) )
```

# loop over scenarios

<https://bookdown.org/yihui/rmarkdown-cookbook/rmarkdown-render.html>

<https://bookdown.org/yihui/rmarkdown-cookbook/parameterized-reports.html>

or
<https://bookdown.org/yihui/rmarkdown/parameterized-reports.html>

```{r}

for (state in state.name) {
  rmarkdown::render(
    'input.Rmd', output_file = paste0(state, '.html')
  )
}

---
title: "A report for `r state`"
output: html_document
---

The area of `r state` is `r state.area[state.name == state]`
square miles.
```

## Better

```{r}
for (state in state.name) {
  rmarkdown::render('input.Rmd', params = list(state = state))
}

---
title: "A report for `r params$state`"
output: html_document
---

The area of `r params$state` is
`r state.area[state.name == params$state]`
square miles.
```

## better

```{r}
render_one <- function(state, year) {
  # assuming the output format of input.Rmd is PDF
  rmarkdown::render(
    'input.Rmd',
    output_file = paste0(state, '-', year, '.pdf'),
    params = list(state = state, year = year),
    envir = parent.frame()
  )
}

for (state in state.name) {
  for (year in 2000:2020) {
    render_one(state, year)
  }
}
```

At the end, you will get a series of
report files like Alabama-2000.pdf,
Alabama-2001.pdf, ..., Wyoming-2019.pdf,
and Wyoming-2020.pdf.

# Note, hack of legends

```{r}
plot <- ggplot(data) +
  geom_line(aes_string(x="Date", y="Value", colour="ShortName"), size=1.2) +
  # add 4 quarter moving average series
  geom_line(aes(x=Date,
                y=rollmean(Value, k=4, fill=NA, align="right"),
                linetype =  'Moving average'),
            colour="red") +
  scale_colour_economist(name='') +
  #scale_colour_manual('', values = "blue") +
  scale_linetype_manual('', values = 1) +
  theme_economist_white(gray_bg=FALSE)

plot + guides(colour = guide_legend(order = 1),
              linetype = guide_legend(order = 2))
```

# Note, geom_textdensity

```{r g_alt_Own_den, eval=FALSE, include=FALSE}
  geom_textdensity(show.legend = FALSE,
                   size = 3.5, vjust = -.2, hjust = .4,
                   gap = TRUE +
                     scale_vjust_discrete()) +
  geom_density(alpha = .1, show.legend = FALSE) +
     xlab("INEXUS metric (Freq 50%)")
```

```{r g_total_distold}

g_total_density4 <- map(df_in_a_list, ~fxTotalDen(.,names(.)))

names(g_total_density3)

names(df_in_a_list)

g_total_density24 <- map(names(df_in_a_list),

                        ~fxTotalDen(df_in_a_list[[.]],

                                    .)

                        )

g_total_density24

namesList <-  as.list(names(df_in_a_list))

names(df_in_a_list)

listOfNames_of_dfs

g_total_density24 <- map(listOfNames_of_dfs,

                        ~fxTotalDen(df_in_a_list[[.]],

                                    .)

                        )

g_total_density2

```

```{r g_base_total}

# (

#   g1b <-

#   geom_density(data = df_temp_compare ,

#                aes(x=exp(logsum_trip_mode_AS_trips),

#                    group = l_baseTotal,

#                color = l_baseTotal   ),

#                fill = "grey",

#                alpha = .3

#                )

# )

# (g1b_0 <- g0 + g1b )

```

### Alternate Scenario, total pop

```{r g_alt_total}

(g1c <-

  geom_density(data = df_temp_compare ,

               aes(x=exp(logsum_trip_mode_AS_trips.alt),

                   group = l_altTotal,

                   color = l_altTotal,

                   fill = l_altTotal),

               alpha = .4

               )

)

(g1c_0 <- g0 + g1c)

```

### base and alternate scenario, total pop

```{r g_altBase_total}

(g1c_b <- g1c_0 + g1b)

# ADD a average line

```

## INCOME: with hi lo 10% income

### base scenario, Hi low income

```{r g_base_incHL10}

# (g2b2 <- g0 +

(g2b2 <-  geom_density(data = (df_temp_compare %>%

                 filter(income10levels == 1 | income10levels==10)),

               aes(x=exp(logsum_trip_mode_AS_trips.base),

                   group = l_baseXincHiLo10,

                   color = l_baseXincHiLo10,

                   fill = l_baseXincHiLo10

                   ),

               alpha = .2

               )

)

(g2b2_0 <- g0 + g2b2)

```

### base scenario, Hi low income

```{r g_base_incTot}

(g2b2_0 <- g0 + g1b + g2b2)

```

### alternate scenario, Hi low income

```{r g_alt_incHL10}

# (g2c2 <- g0 +

(g2c2 <-  geom_density(data = (df_temp_compare %>%

                                 filter(income10levels == 1 |

                                          income10levels==10)),

                       aes(x=exp(logsum_trip_mode_AS_trips.alt),

                           group = l_altXincHiLo10,

                           color = l_altXincHiLo10,

                           fill = l_altXincHiLo10),

                       alpha = .3

)

)

(g2c2_0 <- g0 + g2c2 + g2c2)

```

### alternate and base scenario, Hi low income

```{r g_altBase_incHL10}

(g0 + g2b2)

(g_altBase_incHL10 <- g0 + g2c2 + g2b2)

```

### base scenario, Hi low income

```{r g_base_incHL10_Tot}

(g2b3 <- g0 + g1b + g2c2)

```

## Car OWNERSHIP

### base scenario, owns vehicle

```{r g_base_Own_den, eval=TRUE, include=TRUE}

# p <-

q1 <-  df_temp_compare %>%

  ggplot(aes(x=exp(logsum_trip_mode_AS_trips.base),

             fill = ownCarYNLabel,

             color = ownCarYNLabel,

             label = ownCarYNLabel

             ))+

  scale_x_continuous(limits = c(-.1,1.7)) +

  geom_textdensity(show.legend = FALSE,

                   size = 3.5, vjust = -.5, hjust = .4,

                   gap = TRUE +

                     scale_vjust_discrete()) +

  geom_density(alpha = .1, show.legend = FALSE) +

  theme_bw() +

  scale_fill_vibrant() +

     xlab("INEXUS metric (baseline)")

print(q1)

```

# Scatter plots!!

# facets Examples

```{r}

```

```{r eval=FALSE, include=FALSE}
ggplot(diamonds, aes(log10(carat), log10(price))) + 
  geom_bin2d() + 
  facet_wrap(vars(cut), nrow = 1)
```

```{r eval=FALSE, include=FALSE}
ggplot(mpg, aes(displ, hwy, colour = factor(cyl))) +
  geom_point() + 
  gghighlight::gghighlight() + 
  facet_wrap(vars(cyl))
```

```{r eval=FALSE, include=FALSE}
df <- data.frame(
  x = rnorm(120, c(0, 2, 4)),
  y = rnorm(120, c(1, 2, 1)),
  z = letters[1:3]
)

ggplot(df, aes(x, y)) + 
  geom_point(aes(colour = z))

df_sum <- df %>% 
  group_by(z) %>% 
  summarise(x = mean(x), y = mean(y)) %>%
  rename(z2 = z)
ggplot(df, aes(x, y)) + 
  geom_point() + 
  geom_point(data = df_sum, aes(colour = z2), size = 4) + 
  facet_wrap(~z)

df2 <- dplyr::select(df, -z)

ggplot(df, aes(x, y)) + 
  geom_point(data = df2, colour = "grey70") +
  geom_point(aes(colour = z)) + 
  facet_wrap(~z)
```

# Patchwork Example

```{r eval=FALSE, include=FALSE}
p1 <- ggplot(mpg) + 
  geom_point(aes(x = displ, y = hwy))

p2 <- ggplot(mpg) + 
  geom_bar(aes(x = as.character(year), fill = drv), position = "dodge") + 
  labs(x = "year")

p3 <- ggplot(mpg) + 
  geom_density(aes(x = hwy, fill = drv), colour = NA) + 
  facet_grid(rows = vars(drv))

p4 <- ggplot(mpg) + 
  stat_summary(aes(x = drv, y = hwy, fill = drv), geom = "col", fun.data = mean_se) +
  stat_summary(aes(x = drv, y = hwy), geom = "errorbar", fun.data = mean_se, width = 0.5)
p3
```

```{r eval=FALSE, include=FALSE}
library(patchwork)

p1 + p2
p1 + p2 + p3 + p4
p3 | (p2 / (p1 | p4))
```

```{r eval=FALSE, include=FALSE}
p1 + p2 + p3 + plot_layout(ncol = 2, guides = "collect")
p1 + p2 + p3 + guide_area() + plot_layout(ncol = 2, guides = "collect")
```

## Modify subplots

```{r eval=FALSE, include=FALSE}
p12 <- p1 + p2
p12[[2]] <- p12[[2]] + theme_light()
p12
p1 + p4 & theme_minimal()
```

```{r eval=FALSE, include=FALSE}
p34 <- p3 + p4 + plot_annotation(
  title = "A closer look at the effect of drive train in cars",
  caption = "Source: mpg dataset in ggplot2"
)
p34
p123 <- p1 | (p2 / p3)
p123 + plot_annotation(tag_levels = "I") # Uppercase roman numerics
p123[[2]] <- p123[[2]] + plot_layout(tag_level = "new")
p123 + plot_annotation(tag_levels = c("I", "a"))
p1 + inset_element(p2, left = 0.5, bottom = 0.4, right = 0.9, top = 0.95)

```

```{r ADD_LEGEND, eval=FALSE, include=FALSE}
huron <- data.frame(year = 1875:1972, level = as.numeric(LakeHuron))
ggplot(huron, aes(year)) +
  geom_line(aes(y = level + 5), colour = "red") +
  geom_line(aes(y = level - 5), colour = "blue")

ggplot(huron, aes(year)) +
  geom_line(aes(y = level + 5, colour = "above")) +
  geom_line(aes(y = level - 5, colour = "below")) +
  scale_colour_manual("Direction",
    values = c("above" = "red", "below" = "blue")
  )
```

## Identity plot

```{r eval=FALSE, include=FALSE}
head(luv_colours)
#>      L         u    v           col
#> 1 9342 -3.37e-12    0         white
#> 2 9101 -4.75e+02 -635     aliceblue
#> 3 8810  1.01e+03 1668  antiquewhite
#> 4 8935  1.07e+03 1675 antiquewhite1
#> 5 8452  1.01e+03 1610 antiquewhite2
#> 6 7498  9.03e+02 1402 antiquewhite3

ggplot(luv_colours, aes(u, v)) + 
geom_point(aes(colour = col), size = 3) + 
scale_color_identity() + 
coord_equal()
```

```{r eval=FALSE, include=FALSE}
ggplot(mpg, aes(cty, hwy)) + 
  geom_point(aes(colour = "darkblue")) + 
  scale_colour_identity()
```

```{r eval=FALSE, include=FALSE}
ggplot(mpg, aes(displ, hwy)) + 
  geom_point() +
  geom_smooth(aes(colour = "loess"), method = "loess", se = FALSE) + 
  geom_smooth(aes(colour = "lm"), method = "lm", se = FALSE) +
  labs(colour = "Method")
#> `geom_smooth()` using formula 'y ~ x'
#> `geom_smooth()` using formula 'y ~ x'
```

# Count density

```{r eval=FALSE, include=FALSE}
ggplot(diamonds, aes(price, colour = cut)) + 
  geom_freqpoly(binwidth = 500) +
  theme(legend.position = "none")

ggplot(diamonds, aes(price, colour = cut)) + 
  geom_freqpoly(aes(y = after_stat(density)), binwidth = 500) + 
  theme(legend.position = "none")
```

# Notes to myself

<https://dcl-prog.stanford.edu/purrr-parallel.html>

```{r eval=FALSE, include=FALSE}
# With imap, going through a list using a |> , .x is the thing in the list, and .y is the name of the thing in the list.  So like, .x is each dataframe in the list, and .y is the name of the dataframe in the list. The other way is    map2( .x = df_in_a_list, .y = names(df_in_a_list), ~fx_H...

# tempHeterogenn <- "ownCarYNLabel"
# tempHeterogenn <- "l_inc_HiLo10"

# tempHeterogenn2 <- list("ownCarYNLabel", ""

# g_Het_WithinScenario <-
#   # df_in_a_list |>
#   imap(df_in_a_list, ~ fx_Het_WithinScenario(df = .x,
#                                 nm = .y,
#                                 het = tempHeterogenn))
```

# Notes to myself

```{r eval = FALSE}

    rmarkdown::render("diamond-sizes.Rmd", output_format = "word_document")

```

    knitr::kable(

mtcars[1:5, ],

caption = "A knitr kable."

)

<!-- <!-- # End -->

`{r} --> <!--` --\> \## s0 Base LS
scatter plot

```{r s0}
(s0 <- ggplot() +
  scale_x_continuous(limits = c(-.05,1.7)) +
  scale_y_continuous(limits = c(-.05,1.7)) +
  scale_fill_vibrant() +
  scale_color_vibrant() +
  xlab("INEXUS baseline scenario") +
  ylab("INEXUS alternate scenario")
 ) --> <!-- ```
# Scatter
s1 <-
  geom_point(data = (df_temp_compare %>%
               filter(income10levels!=0) %>%
               filter(income10levels==1 | income10levels==10)),
             aes(x = exp(logsum_trip_mode_AS_trips.base),
                 y = exp(logsum_trip_mode_AS_trips.alt),
                 color = as_factor(ownCarYNLabel)),
             alpha = .15)
s2 <-
  geom_point(data = (df_temp_compare %>%
               filter(income10levels!=0) %>%
               filter(income10levels==1 | income10levels==10)),
             aes(x = exp(logsum_trip_mode_AS_trips.base),
                 y = exp(logsum_trip_mode_AS_trips.alt),
                 color = l_inc_HiLo10),
             alpha = .05)
s3 <-
  geom_point(data = (df_temp_compare %>%
               filter(income10levels!=0) %>%
               filter(income10levels==1 | income10levels==10)),
             aes(x = exp(logsum_trip_mode_AS_trips.base),
                 y = exp(logsum_trip_mode_AS_trips.alt),
                 color = as_factor(ownCarYNLabel)),
             alpha = .15)
sgrey <-
  geom_point(data = (df_temp_compare %>%
               filter(income10levels!=0) %>%
               filter(income10levels==1 | income10levels==10)),
             aes(x = exp(logsum_trip_mode_AS_trips.base),
                 y = exp(logsum_trip_mode_AS_trips.alt)),
             color = "grey",
             alpha = .05)
sNoCar <-
  geom_point(data = (df_temp_compare %>%
                       filter(income10levels!=0) %>%
                       filter(income10levels==1 |
                                income10levels==10) %>%
                       filter(ownCarYNLabel == "Does not own Car")
                     ),
             aes(x = exp(logsum_trip_mode_AS_trips.base),
                 y = exp(logsum_trip_mode_AS_trips.alt)
                 ),
             color = "red",
             alpha = .5)
sNoCarXlowIncome <-
  geom_point(data = (df_temp_compare %>%
                       filter(income10levels!=0) %>%
                       filter(income10levels==1 ) %>%
                       filter(ownCarYNLabel == "Does not own Car")
                     ),
             aes(x = exp(logsum_trip_mode_AS_trips.base),
                 y = exp(logsum_trip_mode_AS_trips.alt)
                 ),
             color = "green",
             alpha = .1)
sCarXHigh <-
  geom_point(data = (df_temp_compare %>%
                       filter(income10levels!=0) %>%
                       filter(income10levels==10 ) %>%
                       filter(ownCarYNLabel == "Owns Car")
                     ),
             aes(x = exp(logsum_trip_mode_AS_trips.base),
                 y = exp(logsum_trip_mode_AS_trips.alt)
                 ),
             color = "#2d84c8",
             shape = ".",
             alpha = .3)
sTransitNoCar <-
  geom_point(data = (df_temp_compare %>%
               filter(income10levels!=0) %>%
                 filter(mode_5categories.base == "transit") %>%
                 filter(ownCarYNLabel == "Does not own Car")),
             aes(x = exp(logsum_trip_mode_AS_trips.base),
                 y = exp(logsum_trip_mode_AS_trips.alt)),
             color = 'purple',
             alpha = .8,)
sTransitNoCarLowInc <-
  geom_point(data = (df_temp_compare %>%
               filter(income10levels==1) %>%
                 filter(mode_5categories.base == "transit") %>%
                 filter(ownCarYNLabel == "Does not own Car")),
             aes(x = exp(logsum_trip_mode_AS_trips.base),
                 y = exp(logsum_trip_mode_AS_trips.alt)),
             color = "#27A493",
             alpha = .8,
             size = 1.2 )
```

# Which people are better and worse off?

Need to work with the scaling etc

## This is light blue, people with a carand high income, and turquoise takes transit, no car, low income

### possibly people without cars who take transit are worse than they were in baseline but hard to tell

<https://s3.console.aws.amazon.com/s3/buckets/beam-core-act?region=us-east-2&prefix=deepDive/CleanData/SanFrancisco/RideHail_FleetSize/&showversions=false>

<https://s3.console.aws.amazon.com/s3/buckets/beam-core-act?region=us-east-2&prefix=deepDive/CleanData/SanFrancisco/RideHail_FleetSize/&showversions=false>

<https://s3.console.aws.amazon.com/s3/buckets/beam-core-act?region=us-east-2&prefix=deepDive/CleanData/SanFrancisco/TransitHead_Frequencies/&showversions=false>

```{r 45d}

s0 +

  # sgrey +

   sCarXHigh +

   # sNoCarXlowIncome +

  sTransitNoCarLowInc +

  geom_abline(intercept = 0, slope = 1, size = 1)

```
